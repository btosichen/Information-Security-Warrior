<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è³‡å®‰å‹‡è€…ï¼šæ ¡åœ’è³‡æ–™å®ˆè­·æˆ°v1.1</title>
    <!-- 
        GitHub Pages éƒ¨ç½² 3 æ­¥é©Ÿï¼š
        1. å»ºç«‹ GitHub Repositoryã€‚
        2. ä¸Šå‚³æ­¤æª”æ¡ˆä¸¦å‘½åç‚º index.htmlã€‚
        3. åœ¨ Settings -> Pages å•Ÿå‹• GitHub Pages æœå‹™ã€‚
    -->
    <style>
        :root {
            --primary: #4F46E5;
            --primary-dark: #4338ca;
            --secondary: #ec4899;
            --accent: #8b5cf6;
            --bg-gradient: linear-gradient(135deg, #e0f2fe 0%, #ede9fe 100%);
            --card-bg: rgba(255, 255, 255, 0.95);
            --text-main: #1f2937;
            --text-light: #6b7280;
            --success: #10b981;
            --danger: #ef4444;
            --font-main: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; user-select: none; }
        body { font-family: var(--font-main); background: var(--bg-gradient); color: var(--text-main); min-height: 100vh; display: flex; justify-content: center; align-items: center; padding: 10px; }
        
        /* Containers */
        .container { width: 100%; max-width: 600px; position: relative; }
        .screen { display: none; animation: fadeIn 0.4s ease; }
        .screen.active { display: block; }
        
        /* Cards */
        .card { background: var(--card-bg); border-radius: 16px; padding: 24px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); margin-bottom: 20px; backdrop-filter: blur(5px); }
        .card-header { margin-bottom: 16px; text-align: center; }
        .card-title { font-size: 1.5rem; font-weight: bold; color: var(--primary); margin-bottom: 8px; }
        
        /* Forms & Inputs */
        .form-group { margin-bottom: 16px; text-align: left; }
        label { display: block; margin-bottom: 6px; font-weight: 600; font-size: 0.9rem; }
        input, select { width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 1rem; transition: 0.2s; outline: none; }
        input:focus, select:focus { border-color: var(--primary); }

        /* Buttons */
        .btn { display: inline-block; width: 100%; padding: 14px; background: var(--primary); color: white; border: none; border-radius: 10px; font-size: 1rem; font-weight: bold; cursor: pointer; transition: transform 0.1s, background 0.2s; margin-top: 10px; }
        .btn:hover { background: var(--primary-dark); }
        .btn:active { transform: scale(0.98); }
        .btn-secondary { background: white; color: var(--text-main); border: 2px solid #e5e7eb; }
        .btn-secondary:hover { background: #f3f4f6; }
        .btn-danger { background: var(--danger); }
        .btn-outline-danger { background: transparent; border: 1px solid var(--danger); color: var(--danger); }
        .btn-small { padding: 8px 16px; font-size: 0.85rem; width: auto; }
        
        /* Teacher Dashboard Styles */
        .dashboard-controls { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 15px; }
        .table-container { overflow-x: auto; max-height: 400px; border: 1px solid #e5e7eb; border-radius: 8px; }
        table { width: 100%; border-collapse: collapse; font-size: 0.9rem; min-width: 600px; }
        th, td { padding: 10px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: #f9fafb; position: sticky; top: 0; }
        .tag-badge { font-size: 0.75rem; padding: 2px 6px; border-radius: 4px; background: #ddd; margin-right: 4px; }
        
        /* Game UI */
        .game-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; font-weight: bold; color: var(--text-light); }
        .progress-bar { height: 8px; background: #e5e7eb; border-radius: 4px; overflow: hidden; margin-bottom: 20px; }
        .progress-fill { height: 100%; background: var(--success); width: 0%; transition: width 0.3s; }
        
        .story-text { font-size: 1.1rem; line-height: 1.6; margin-bottom: 20px; color: #374151; background: #f0f9ff; padding: 15px; border-radius: 8px; border-left: 4px solid var(--primary); }
        .npc-box { display: flex; gap: 10px; margin-bottom: 20px; align-items: flex-start; }
        .npc-avatar { width: 50px; height: 50px; background: #ddd; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; flex-shrink: 0; }
        .npc-dialogue { background: #fff; border: 1px solid #e5e7eb; padding: 12px; border-radius: 0 12px 12px 12px; font-size: 0.95rem; width: 100%; }
        
        .items-bar { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 10px; margin-bottom: 15px; }
        .item-btn { flex: 1; min-width: 80px; padding: 8px; font-size: 0.8rem; background: #fff; border: 1px solid #d1d5db; border-radius: 8px; cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 4px; opacity: 0.7; }
        .item-btn.available { opacity: 1; border-color: var(--accent); color: var(--accent); background: #f5f3ff; }
        .item-btn:disabled { cursor: not-allowed; opacity: 0.4; }

        .question-area { margin-top: 20px; }
        .q-text { font-size: 1.2rem; font-weight: bold; margin-bottom: 15px; }
        .options-grid { display: grid; gap: 10px; }
        .option-btn { text-align: left; padding: 15px; background: white; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 1rem; cursor: pointer; }
        .option-btn:hover { border-color: var(--primary); background: #eef2ff; }
        .option-btn.hidden-opt { display: none; }

        /* Animations */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Feedback Modal */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 100; }
        .modal { background: white; padding: 30px; border-radius: 16px; width: 90%; max-width: 500px; text-align: center; animation: fadeIn 0.3s; }
        .feedback-icon { font-size: 3rem; margin-bottom: 10px; display: block; }
        .correct { color: var(--success); }
        .wrong { color: var(--danger); }
        
        .chapter-filter { border: 1px solid #ccc; padding: 10px; border-radius: 8px; margin-bottom: 15px; background: #fff; }
        .chapter-filter h4 { margin-bottom: 8px; color: var(--primary); }
        .checkbox-group { display: flex; gap: 15px; flex-wrap: wrap; }
        .checkbox-label { display: flex; align-items: center; gap: 5px; cursor: pointer; }

        .dev-badge { position: absolute; top: 10px; right: 10px; font-size: 0.8rem; background: rgba(0,0,0,0.1); padding: 4px 8px; border-radius: 4px; cursor: pointer; }
    </style>
</head>
<body>

<div class="container">
    <div class="dev-badge" onclick="app.toggleTeacherPanel()">ğŸ‘©â€ğŸ« è€å¸«å°ˆå€</div>

    <!-- 1. ç™»å…¥ç•«é¢ -->
    <div id="screen-login" class="screen active">
        <div class="card">
            <div class="card-header">
                <div style="font-size: 3rem; margin-bottom: 10px;">ğŸ›¡ï¸</div>
                <h1 class="card-title">è³‡å®‰å‹‡è€…ï¼šæ ¡åœ’è³‡æ–™å®ˆè­·æˆ°</h1>
                <p>è«‹è¼¸å…¥å‹‡è€…è³‡æ–™ä»¥é–‹å§‹ä»»å‹™</p>
            </div>
            <div class="form-group">
                <label>ç­ç´š</label>
                <input type="text" id="login-class" placeholder="ä¾‹å¦‚ï¼š701">
            </div>
            <div class="form-group">
                <label>åº§è™Ÿ</label>
                <input type="number" id="login-seat" placeholder="ä¾‹å¦‚ï¼š05">
            </div>
            <div class="form-group">
                <label>å§“å</label>
                <input type="text" id="login-name" placeholder="è«‹è¼¸å…¥çœŸå¯¦å§“å">
            </div>
            <button class="btn" onclick="app.handleLogin()">é–‹å§‹ä»»å‹™</button>
        </div>
    </div>

    <!-- 2. éŠæˆ²ä¸»ç•«é¢ -->
    <div id="screen-game" class="screen">
        <div class="game-header">
            <span id="game-timer">â³ 00:00</span>
            <span id="game-level">é—œå¡ 1/10</span>
            <span id="game-score">ğŸ† 0</span>
        </div>
        <div class="progress-bar"><div class="progress-fill" id="progress-fill"></div></div>

        <!-- é“å…·æ¬„ -->
        <div class="items-bar">
            <button class="item-btn available" id="item-firewall" onclick="app.useItem('firewall')">
                <span>ğŸ›¡ï¸ é˜²ç«ç‰†</span>
                <span style="font-size:0.7em" id="count-firewall">x2</span>
            </button>
            <button class="item-btn available" id="item-scroll" onclick="app.useItem('scroll')">
                <span>ğŸ” å·è»¸</span>
                <span style="font-size:0.7em" id="count-scroll">x2</span>
            </button>
            <button class="item-btn available" id="item-lens" onclick="app.useItem('lens')">
                <span>ğŸ” åµæ¸¬é¡</span>
                <span style="font-size:0.7em" id="count-lens">x2</span>
            </button>
            <button class="item-btn available" id="item-log" onclick="app.useItem('log')">
                <span>ğŸ§¾ ç´€éŒ„ç°¿</span>
                <span style="font-size:0.7em" id="count-log">x2</span>
            </button>
        </div>

        <div class="card">
            <!-- æ•…äº‹èˆ‡ NPC å€ -->
            <div id="scene-area">
                <div class="story-text" id="story-text">è¼‰å…¥ä¸­...</div>
                <div class="npc-box">
                    <div class="npc-avatar" id="npc-avatar">ğŸ‘¨â€ğŸ«</div>
                    <div class="npc-dialogue">
                        <strong id="npc-name">NPC</strong>
                        <p id="npc-msg">...</p>
                        <!-- é€™è£¡æœƒå‹•æ…‹æ’å…¥å°æ¸¬é©—æŒ‰éˆ• -->
                        <div id="npc-choices" style="margin-top:10px; display:flex; gap:8px; flex-wrap:wrap; justify-content: flex-end;"></div>
                    </div>
                </div>
            </div>

            <!-- é¡Œç›®å€ -->
            <div class="question-area" id="quiz-area" style="display:none;">
                <div class="q-text" id="q-text">é¡Œç›®æ–‡å­—</div>
                <div id="q-options" class="options-grid"></div>
                <div id="q-input-area" style="display:none;">
                    <input type="text" id="q-input" placeholder="è«‹è¼¸å…¥ç­”æ¡ˆ...">
                    <button class="btn" style="margin-top:10px" onclick="app.submitAnswer()">é€å‡ºç­”æ¡ˆ</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 3. çµç®—ç•«é¢ -->
    <div id="screen-result" class="screen">
        <div class="card" style="text-align: center;">
            <div style="font-size: 4rem; margin-bottom: 10px;">ğŸ‰</div>
            <h2 class="card-title">ä»»å‹™å®Œæˆï¼</h2>
            <p>è³‡å®‰å‹‡è€…ï¼Œçœ‹çœ‹ä½ çš„æˆ°ç¸¾</p>
            
            <div style="margin: 20px 0; font-size: 1.2rem;">
                <p>ç¸½åˆ†ï¼š<span id="final-score" style="color:var(--primary); font-weight:bold;">0</span></p>
                <p>æ­£ç¢ºç‡ï¼š<span id="final-accuracy">0%</span></p>
                <p>è€—æ™‚ï¼š<span id="final-time">0s</span></p>
            </div>

            <div style="text-align: left; margin-top: 20px;">
                <h3>éŒ¯é¡Œå›é¡§ï¼š</h3>
                <div id="review-list" style="margin-top:10px; font-size: 0.9rem; color: #555;">
                    <!-- JS ç”Ÿæˆ -->
                </div>
            </div>

            <button class="btn" onclick="location.reload()">å†ç©ä¸€æ¬¡ (é‡æŠ½é¡Œç›®)</button>
        </div>
    </div>

    <!-- 4. è€å¸«å¾Œå° -->
    <div id="screen-dashboard" class="screen">
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">ğŸ‘©â€ğŸ« è€å¸«ç®¡ç†å¾Œå°</h2>
                <p>ç®¡ç†å­¸ç”Ÿä½œç­”ç´€éŒ„èˆ‡å‡ºé¡Œè¨­å®š</p>
            </div>

            <!-- ç« ç¯€è¨­å®š -->
            <div class="chapter-filter">
                <h4>ğŸ¯ ä»Šæ—¥å‡ºé¡Œç« ç¯€è¨­å®š</h4>
                <div class="checkbox-group" id="chapter-checks">
                    <label class="checkbox-label"><input type="checkbox" value="å€‹è³‡" checked> å€‹äººè³‡æ–™ (PDPA)</label>
                    <label class="checkbox-label"><input type="checkbox" value="CIA" checked> è³‡è¨Šå®‰å…¨ (CIA)</label>
                    <label class="checkbox-label"><input type="checkbox" value="é‡£é­š" checked> é‡£é­šèˆ‡ç¤¾äº¤å·¥ç¨‹</label>
                    <label class="checkbox-label"><input type="checkbox" value="3A4D" checked> ç®¡ç†èˆ‡æŠ€è¡“ (3A/4D)</label>
                </div>
                <div style="margin-top: 10px; display: flex; gap: 10px;">
                    <button class="btn btn-small" onclick="app.saveConfig()">å„²å­˜è¨­å®š</button>
                    <span id="config-status" style="font-size: 0.8rem; color: var(--success); display: none; align-self: center;">å·²å„²å­˜!</span>
                </div>
            </div>

            <div class="dashboard-controls">
                <input type="text" id="dash-search" placeholder="æœå°‹å§“åæˆ–ç­ç´š..." style="width: 200px; padding: 8px;">
                <button class="btn btn-small" onclick="app.renderDashboard()">é‡æ–°æ•´ç†</button>
                <button class="btn btn-small btn-secondary" onclick="app.exportCSV()">ğŸ“¥ åŒ¯å‡º CSV</button>
                <button class="btn btn-small btn-outline-danger" onclick="app.clearData()">ğŸ—‘ï¸ æ¸…é™¤è³‡æ–™</button>
                <button class="btn btn-small btn-secondary" onclick="location.reload()">å›åˆ°éŠæˆ²</button>
            </div>

            <div class="table-container">
                <table id="dash-table">
                    <thead>
                        <tr>
                            <th>æ™‚é–“</th>
                            <th>ç­ç´š</th>
                            <th>å§“å</th>
                            <th>é—œå¡</th>
                            <th>åˆ†æ•¸</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            
            <div id="dash-detail" style="margin-top: 20px; border-top: 1px solid #eee; padding-top: 10px; display: none;">
                <h4>ä½œç­”æ˜ç´°</h4>
                <div id="dash-detail-content"></div>
            </div>
        </div>
    </div>
</div>

<!-- å›é¥‹ Modal -->
<div class="modal-overlay" id="feedback-modal">
    <div class="modal">
        <span class="feedback-icon" id="fb-icon">âœ…</span>
        <h3 id="fb-title">æ­£ç¢ºï¼</h3>
        <p id="fb-msg" style="margin: 15px 0; color: #555;">è§£é‡‹æ–‡å­—</p>
        <div id="audit-log-extra" style="display:none; background:#f9f9f9; padding:10px; border-radius:8px; margin-bottom:10px; text-align:left; font-size:0.9rem;">
            <strong>ğŸ§¾ ç¨½æ ¸ç´€éŒ„è©³ç´°åˆ†æï¼š</strong><br><span id="audit-text"></span>
        </div>
        <button class="btn" onclick="app.closeFeedback()">ä¸‹ä¸€é—œ â”</button>
    </div>
</div>

<!-- è€å¸«å¯†ç¢¼é©—è­‰ Modal -->
<div class="modal-overlay" id="password-modal">
    <div class="modal">
        <h3>ğŸ” è€å¸«å°ˆå€é©—è­‰</h3>
        <p style="margin: 15px 0; color: #555;">è«‹è¼¸å…¥ç®¡ç†å¯†ç¢¼</p>
        <!-- type="password" ç¢ºä¿é¡¯ç¤ºæ˜Ÿè™Ÿæˆ–åœ“é» -->
        <input type="password" id="teacher-pwd-input" placeholder="å¯†ç¢¼" style="margin-bottom: 15px;" onkeyup="if(event.key==='Enter') app.checkTeacherPassword()">
        <div style="display: flex; gap: 10px; justify-content: center;">
            <button class="btn btn-secondary btn-small" onclick="app.closePasswordModal()">å–æ¶ˆ</button>
            <button class="btn btn-small" onclick="app.checkTeacherPassword()">ç¢ºèª</button>
        </div>
    </div>
</div>

<script>
/**
 * é¡Œåº«è³‡æ–™çµæ§‹
 * tags: ['å€‹è³‡', 'CIA', 'é‡£é­š', '3A4D']
 */
const QUESTION_POOL = [
    // --- å€‹è³‡èˆ‡æ¬Šåˆ© (1-15) ---
    { id: 'q1', type: 'choice', tags: ['å€‹è³‡'], text: 'ä¸‹åˆ—å“ªä¸€é …ã€Œä¸æ˜¯ã€æˆ‘åœ‹å€‹è³‡æ³•ä¿è­·çš„å€‹äººè³‡æ–™ï¼Ÿ', options: ['èº«åˆ†è­‰å­—è™Ÿ', 'ç—…æ­·', 'å…¬é–‹å ´åˆçš„ç¾¤çœ¾è¨ˆæ•¸', 'æŒ‡ç´‹'], answer: 'å…¬é–‹å ´åˆçš„ç¾¤çœ¾è¨ˆæ•¸', explanation: 'ç„¡æ³•ç›´æ¥æˆ–é–“æ¥è­˜åˆ¥ç‰¹å®šå€‹äººçš„çµ±è¨ˆæ•¸æ“šä¸å±¬æ–¼å€‹è³‡ã€‚' },
    { id: 'q2', type: 'choice', tags: ['å€‹è³‡'], text: 'å°æ˜æƒ³è¡Œä½¿å€‹è³‡ç•¶äº‹äººæ¬Šåˆ©ï¼Œä¸‹åˆ—å“ªé …ã€Œä¸åŒ…å«ã€åœ¨å…§ï¼Ÿ', options: ['æŸ¥è©¢é–±è¦½', 'è«‹æ±‚åˆªé™¤', 'è«‹æ±‚æŠŠåˆ¥äººçš„è³‡æ–™çµ¦æˆ‘çœ‹', 'è«‹æ±‚æ›´æ­£'], answer: 'è«‹æ±‚æŠŠåˆ¥äººçš„è³‡æ–™çµ¦æˆ‘çœ‹', explanation: 'ä½ åªèƒ½é‡å°ã€Œè‡ªå·±ã€çš„è³‡æ–™è¡Œä½¿æ¬Šåˆ©ã€‚' },
    { id: 'q3', type: 'boolean', tags: ['å€‹è³‡', 'æ•æ„Ÿ'], text: 'ã€Œç—…æ­·ã€é†«ç™‚ã€åŸºå› ã€æ€§ç”Ÿæ´»ã€å¥åº·æª¢æŸ¥ã€çŠ¯ç½ªå‰ç§‘ã€å±¬æ–¼ç‰¹ç¨®(æ•æ„Ÿ)å€‹è³‡ï¼Œè’é›†æ¢ä»¶æ¯”ä¸€èˆ¬å€‹è³‡æ›´åš´æ ¼ã€‚', answer: true, explanation: 'æ²’éŒ¯ï¼Œé€™äº›è³‡æ–™è‹¥å¤–æ´©å°ç•¶äº‹äººæå®³æ¥µå¤§ï¼ŒåŸå‰‡ä¸Šä¸å¾—è’é›†ã€‚' },
    { id: 'q4', type: 'choice', tags: ['å€‹è³‡'], text: 'å­¸æ ¡åœ¨ç¶²è·¯ä¸Šå…¬å‘Šæ¦®è­½æ¦œï¼Œç‚ºäº†ä¿è­·éš±ç§ï¼Œæ‡‰è©²æ€éº¼åšæ¯”è¼ƒå¥½ï¼Ÿ', options: ['å…¬å‘Šå…¨åå’Œèº«åˆ†è­‰å­—è™Ÿ', 'åªå…¬å‘Šå­¸è™Ÿ', 'å…¬å‘Šå§“åå…¶ä¸­ä¸€å­—éš±è— (å¦‚ï¼šç‹â—‹æ˜)', 'ä¸å…¬å‘Šä»»ä½•è³‡è¨Š'], answer: 'å…¬å‘Šå§“åå…¶ä¸­ä¸€å­—éš±è— (å¦‚ï¼šç‹â—‹æ˜)', explanation: 'é€™å«åšå»è­˜åˆ¥åŒ–ï¼Œèƒ½é”åˆ°å…¬å‘Šç›®çš„åˆèƒ½ä¿è­·éƒ¨åˆ†éš±ç§ã€‚' },
    { id: 'q5', type: 'fill', tags: ['å€‹è³‡'], text: 'ç•¶ç¶²ç«™ä¸å†éœ€è¦ä½¿ç”¨ä½ çš„è³‡æ–™ï¼Œæˆ–ä½ æ’¤å›åŒæ„æ™‚ï¼Œä½ å¯ä»¥è«‹æ±‚ç¶²ç«™è¡Œä½¿ä»€éº¼æ¬Šåˆ©ï¼Ÿ(å…©å­—)', answer: ['åˆªé™¤', 'åˆªé™¤æ¬Š'], explanation: 'è¢«éºå¿˜æ¬Š/åˆªé™¤æ¬Šæ˜¯é‡è¦çš„å€‹è³‡æ¬Šåˆ©ã€‚' },
    { id: 'q6', type: 'boolean', tags: ['å€‹è³‡'], text: 'åªè¦æ˜¯ç‚ºäº†ã€Œæ•™å­¸ç›®çš„ã€ï¼Œè€å¸«å¯ä»¥éš¨æ„æŠŠå­¸ç”Ÿçš„é›»è©±è™Ÿç¢¼çµ¦è£œç¿’ç­ã€‚', answer: false, explanation: 'é€™é•åäº†ã€Œç‰¹å®šç›®çš„ã€åŸå‰‡ï¼Œä¸”æœªç¶“ç•¶äº‹äººåŒæ„ã€‚' },
    { id: 'q7', type: 'choice', tags: ['å€‹è³‡'], text: 'ä¸‹åˆ—ä½•è€…å±¬æ–¼ã€Œé–“æ¥è­˜åˆ¥ã€çš„å€‹è³‡ï¼Ÿ', options: ['æŒ‡ç´‹', 'èº«åˆ†è­‰å­—è™Ÿ', 'èˆ‡å…¶ä»–è³‡æ–™å°ç…§å¾Œå¯èªå‡ºæ˜¯èª°çš„ä»£è™Ÿ', 'å§“å'], answer: 'èˆ‡å…¶ä»–è³‡æ–™å°ç…§å¾Œå¯èªå‡ºæ˜¯èª°çš„ä»£è™Ÿ', explanation: 'å–®ç¨çœ‹ä¸çŸ¥é“æ˜¯èª°ï¼Œä½†é…åˆå…¶ä»–è³‡æ–™å°±èƒ½èªå‡ºä¾†ï¼Œä¹Ÿç®—å€‹è³‡ã€‚' },
    { id: 'q8', type: 'choice', tags: ['å€‹è³‡'], text: 'å€‹è³‡æ³•ä¸­ï¼Œè’é›†å€‹è³‡å¿…é ˆç¬¦åˆä»€éº¼åŸå‰‡ï¼Ÿ', options: ['èª å¯¦ä¿¡ç”¨åŸå‰‡', 'è¶Šå¤šè¶Šå¥½åŸå‰‡', 'å·å·æ‘¸æ‘¸åŸå‰‡', 'å¯ä»¥è³£éŒ¢åŸå‰‡'], answer: 'èª å¯¦ä¿¡ç”¨åŸå‰‡', explanation: 'è’é›†è™•ç†åˆ©ç”¨éƒ½æ‡‰å°Šé‡ç•¶äº‹äººæ¬Šç›Šï¼Œä¸å¾—é€¾è¶Šç‰¹å®šç›®çš„ã€‚' },
    { id: 'q9', type: 'fill', tags: ['å€‹è³‡'], text: 'æ”¶åˆ°ä¸æ˜å»£å‘Šç°¡è¨Šï¼Œå°æ–¹å»çŸ¥é“ä½ çš„åå­—ï¼Œä»£è¡¨ä½ çš„å€‹è³‡å¯èƒ½å·²ç¶“è¢«____ï¼Ÿ(å…©å€‹å­—)', answer: ['å¤–æ´©', 'æ´©æ¼', 'æ´©éœ²'], explanation: 'å€‹è³‡å¤–æ´©æ˜¯å¸¸è¦‹çš„è³‡å®‰äº‹ä»¶ã€‚' },
    { id: 'q10', type: 'boolean', tags: ['å€‹è³‡'], text: 'æœ‹å‹æŠŠä½ çš„é†œç…§åšæˆæ¢—åœ–å‚³åˆ°å…¬é–‹è«–å£‡ï¼Œå¦‚æœèƒ½è­˜åˆ¥å‡ºæ˜¯ä½ ï¼Œé€™ä¹Ÿæ¶‰åŠå€‹è³‡åˆ©ç”¨ã€‚', answer: true, explanation: 'ç…§ç‰‡(è‚–åƒ)ä¹Ÿæ˜¯èƒ½è­˜åˆ¥å€‹äººçš„è³‡æ–™ã€‚' },

    // --- CIA è³‡è¨Šå®‰å…¨ (16-25) ---
    { id: 'q16', type: 'choice', tags: ['CIA'], text: 'è³‡å®‰ä¸‰è¦ç´  CIA ä¸­çš„ã€ŒCã€æŒ‡çš„æ˜¯ä»€éº¼ï¼Ÿ', options: ['å®Œæ•´æ€§ (Integrity)', 'æ©Ÿå¯†æ€§ (Confidentiality)', 'å¯ç”¨æ€§ (Availability)', 'æ§åˆ¶æ€§ (Control)'], answer: 'æ©Ÿå¯†æ€§ (Confidentiality)', explanation: 'æ©Ÿå¯†æ€§ç¢ºä¿è³‡æ–™ä¸è¢«æœªæˆæ¬Šçš„äººçœ‹åˆ°ã€‚' },
    { id: 'q17', type: 'choice', tags: ['CIA'], text: 'é§­å®¢ç«„æ”¹äº†å­¸æ ¡ç¶²ç«™çš„å…¬å‘Šå…§å®¹ï¼Œé€™æ˜¯ç ´å£äº†è³‡å®‰çš„å“ªä¸€é …è¦ç´ ï¼Ÿ', options: ['æ©Ÿå¯†æ€§', 'å®Œæ•´æ€§', 'å¯ç”¨æ€§', 'ä¸å¯å¦èªæ€§'], answer: 'å®Œæ•´æ€§', explanation: 'å®Œæ•´æ€§ (Integrity) ç¢ºä¿è³‡æ–™æ˜¯æ­£ç¢ºã€æœªè¢«éæ³•ç¯¡æ”¹çš„ã€‚' },
    { id: 'q18', type: 'fill', tags: ['CIA'], text: 'DDoS æ”»æ“Šå°è‡´ç¶²ç«™ç™±ç˜“ç„¡æ³•é€£ç·šï¼Œé€™æ˜¯ç ´å£äº† CIA ä¸­çš„å“ªä¸€é …ï¼Ÿ(ä¸‰å€‹å­—)', answer: ['å¯ç”¨æ€§'], explanation: 'Availability (å¯ç”¨æ€§) ç¢ºä¿æœå‹™éš¨æ™‚å¯ç”¨ã€‚' },
    { id: 'q19', type: 'boolean', tags: ['CIA'], text: 'æŠŠæª”æ¡ˆåŠ å¯†æ˜¯ç‚ºäº†ä¿è­·è³‡æ–™çš„ã€Œå®Œæ•´æ€§ã€ã€‚', answer: false, explanation: 'åŠ å¯†ä¸»è¦æ˜¯ä¿è­·ã€Œæ©Ÿå¯†æ€§ã€ï¼Œæ•¸ä½ç°½ç« æ‰æ˜¯ä¿è­·å®Œæ•´æ€§ã€‚' },
    { id: 'q20', type: 'choice', tags: ['CIA'], text: 'ç‚ºäº†é˜²æ­¢å¤©ç½å°è‡´è³‡æ–™éºå¤±ï¼Œæˆ‘å€‘é€²è¡Œã€Œç•°åœ°å‚™ä»½ã€ï¼Œé€™æ˜¯ç‚ºäº†ç¶­è­·ï¼Ÿ', options: ['æ©Ÿå¯†æ€§', 'å®Œæ•´æ€§', 'å¯ç”¨æ€§', 'é‘‘åˆ¥æ€§'], answer: 'å¯ç”¨æ€§', explanation: 'å‚™ä»½è®“è³‡æ–™åœ¨ç½é›£å¾Œä»å¯å›å¾©ä½¿ç”¨ã€‚' },
    
    // --- é‡£é­šèˆ‡ç¤¾äº¤å·¥ç¨‹ (26-38) ---
    { id: 'q26', type: 'choice', tags: ['é‡£é­š'], text: 'æ”¶åˆ° Email ä¸»æ—¨å¯«ã€Œæ‚¨çš„å¸³è™Ÿå°‡è¢«åœç”¨ï¼Œè«‹é»æ­¤ç«‹å³é©—è­‰ã€ï¼Œé€™æœ€å¯èƒ½æ˜¯ï¼Ÿ', options: ['ç³»çµ±æ­£å¸¸é€šçŸ¥', 'é‡£é­šéƒµä»¶', 'å¥½åº·å„ªæƒ ', 'é˜²æ¯’è»Ÿé«”æ›´æ–°'], answer: 'é‡£é­šéƒµä»¶', explanation: 'åˆ©ç”¨ææ…Œå¿ƒç†èª˜é¨™é»æ“Šé€£çµæ˜¯å…¸å‹é‡£é­šæ‰‹æ³•ã€‚' },
    { id: 'q27', type: 'boolean', tags: ['é‡£é­š'], text: 'å¦‚æœæ˜¯èªè­˜çš„æœ‹å‹å‚³ä¾†çš„é€£çµï¼Œçµ•å°å®‰å…¨ï¼Œå¯ä»¥ç›´æ¥é»é–‹ã€‚', answer: false, explanation: 'æœ‹å‹çš„å¸³è™Ÿå¯èƒ½è¢«ç›œç”¨ï¼Œæ‡‰å…ˆç¢ºèªã€‚' },
    { id: 'q28', type: 'choice', tags: ['é‡£é­š'], text: 'ä¸‹åˆ—å“ªå€‹é™„æª”åæœ€å¯ç–‘ï¼Œåƒè¬ä¸è¦ç›´æ¥åŸ·è¡Œï¼Ÿ', options: ['.txt', '.jpg', '.jpg.exe', '.pdf'], answer: '.jpg.exe', explanation: 'é€™æ˜¯åˆ©ç”¨é›™é‡å‰¯æª”åå½è£æˆåœ–ç‰‡çš„åŸ·è¡Œæª”(ç—…æ¯’)ã€‚' },
    { id: 'q29', type: 'choice', tags: ['é‡£é­š'], text: 'ã€Œç¤¾äº¤å·¥ç¨‹ã€æ”»æ“Šé€šå¸¸æ˜¯åˆ©ç”¨ä»€éº¼å¼±é»ï¼Ÿ', options: ['é›»è…¦ç³»çµ±æ¼æ´', 'é˜²ç«ç‰†è¨­å®šéŒ¯èª¤', 'äººæ€§çš„å¼±é»', 'ç¶²è·¯é€Ÿåº¦å¤ªæ…¢'], answer: 'äººæ€§çš„å¼±é»', explanation: 'åˆ©ç”¨ä¿¡ä»»ã€è²ªå©ªã€ææ‡¼ç­‰å¿ƒç†ä¾†è©é¨™ã€‚' },
    { id: 'q30', type: 'fill', tags: ['é‡£é­š'], text: 'æª¢æŸ¥ç¶²å€æ™‚ï¼Œç™¼ç¾ `google.com` è®Šæˆäº† `goog1e.com`ï¼Œé€™æ˜¯ä¸€ç¨®____ç¶²å€æ”»æ“Šã€‚', answer: ['é‡£é­š', 'å½é€ ', 'æƒ¡æ„'], explanation: 'é€éç›¸ä¼¼å­—å…ƒ(Typosquatting)æ··æ·†è¦–è½ã€‚' },
    { id: 'q31', type: 'boolean', tags: ['é‡£é­š'], text: 'çœ‹åˆ°çŸ­ç¶²å€ (å¦‚ bit.ly) æ‡‰è©²æé«˜è­¦è¦ºï¼Œå¯ä½¿ç”¨é‚„åŸå·¥å…·å…ˆæŸ¥çœ‹çœŸå¯¦ç¶²å€ã€‚', answer: true, explanation: 'çŸ­ç¶²å€å¸¸è¢«ç”¨ä¾†éš±è—æƒ¡æ„é€£çµã€‚' },

    // --- æŠ€è¡“èˆ‡ç®¡ç† 3A/4D/é˜²è­· (39-50) ---
    { id: 'q39', type: 'choice', tags: ['3A4D'], text: 'åœ¨ 3A ç®¡ç†ä¸­ï¼Œè¼¸å…¥å¸³è™Ÿå¯†ç¢¼è­‰æ˜ã€Œä½ æ˜¯èª°ã€çš„éç¨‹ç¨±ç‚ºï¼Ÿ', options: ['èªè­‰ (Authentication)', 'æˆæ¬Š (Authorization)', 'ç´€éŒ„ (Accounting)', 'å¯©è¨ˆ (Auditing)'], answer: 'èªè­‰ (Authentication)', explanation: 'AuthN æ˜¯é©—è­‰èº«åˆ†ï¼ŒAuthZ æ˜¯æ±ºå®šä½ èƒ½åšä»€éº¼ã€‚' },
    { id: 'q40', type: 'choice', tags: ['3A4D'], text: 'é˜²ç«ç‰†(Firewall) çš„ä¸»è¦åŠŸèƒ½æ˜¯ä»€éº¼ï¼Ÿ', options: ['æ®ºæ­»ç—…æ¯’', 'éæ¿¾é€²å‡ºçš„ç¶²è·¯å°åŒ…', 'åŠ å¯†ç¡¬ç¢Ÿ', 'å‚™ä»½è³‡æ–™'], answer: 'éæ¿¾é€²å‡ºçš„ç¶²è·¯å°åŒ…', explanation: 'ä¾ç…§è¦å‰‡å…è¨±æˆ–æ‹’çµ•é€£ç·šã€‚' },
    { id: 'q41', type: 'fill', tags: ['3A4D'], text: 'å°‡è³‡æ–™æ‰“äº‚è®Šæˆäº‚ç¢¼ï¼Œéœ€è¦é‡‘é‘°æ‰èƒ½è§£è®€ï¼Œé€™å€‹æŠ€è¡“ç¨±ç‚º____ã€‚', answer: ['åŠ å¯†', 'encryption'], explanation: 'æ˜æ–‡è½‰å¯†æ–‡çš„éç¨‹ã€‚' },
    { id: 'q42', type: 'choice', tags: ['3A4D'], text: 'åœ¨åœ–ç‰‡ä¸­åŠ å…¥è‚‰çœ¼çœ‹ä¸è¦‹çš„è³‡è¨Šä»¥æ¨™ç¤ºç‰ˆæ¬Šï¼Œé€™æŠ€è¡“å«ï¼Ÿ', options: ['æ•¸ä½æµ®æ°´å°', 'æ•¸ä½ç°½ç« ', 'é›œæ¹Šå‡½æ•¸', 'å€å¡Šéˆ'], answer: 'æ•¸ä½æµ®æ°´å°', explanation: 'éš±æ€§æµ®æ°´å°å¯ç”¨æ–¼ç‰ˆæ¬Šè¿½è¹¤ã€‚' },
    { id: 'q43', type: 'boolean', tags: ['3A4D'], text: 'åœ¨å…¬ç”¨é›»è…¦ç™»å…¥å¾Œï¼Œåªè¦ç›´æ¥é—œæ‰è¦–çª—å°±å¥½ï¼Œä¸ç”¨æŒ‰ç™»å‡ºã€‚', answer: false, explanation: 'ç€è¦½å™¨å¯èƒ½è¨˜ä½ç™»å…¥ç‹€æ…‹(Cookie)ï¼Œä¸‹ä¸€å€‹äººå¯èƒ½ç›´æ¥ç™»å…¥ä½ çš„å¸³è™Ÿã€‚' },
    { id: 'q44', type: 'choice', tags: ['3A4D'], text: 'å®‰å…¨çš„å¯†ç¢¼è¨­å®šåŸå‰‡ï¼Œä¸‹åˆ—ä½•è€…ã€ŒéŒ¯èª¤ã€ï¼Ÿ', options: ['æ··åˆå¤§å°å¯«èˆ‡æ•¸å­—', 'è‡³å°‘8ç¢¼ä»¥ä¸Š', 'å®šæœŸæ›´æ›', 'ä½¿ç”¨ç”Ÿæ—¥ä»¥å…å¿˜è¨˜'], answer: 'ä½¿ç”¨ç”Ÿæ—¥ä»¥å…å¿˜è¨˜', explanation: 'ç”Ÿæ—¥å®¹æ˜“è¢«çŒœæ¸¬æˆ–ç¤¾äº¤å·¥ç¨‹ç²å–ï¼Œä¸æ‡‰ä½œç‚ºå¯†ç¢¼ã€‚' },
    { id: 'q45', type: 'choice', tags: ['3A4D'], text: 'ä¸‹åˆ—ä½•è€…å±¬æ–¼ã€Œé›™é‡é©—è­‰ (2FA)ã€ï¼Ÿ', options: ['è¼¸å…¥å…©æ¬¡å¯†ç¢¼', 'å¯†ç¢¼ + æ‰‹æ©Ÿç°¡è¨Šé©—è­‰ç¢¼', 'å¯†ç¢¼ + èº«åˆ†è­‰å­—è™Ÿ', 'å¸³è™Ÿ + å¯†ç¢¼'], answer: 'å¯†ç¢¼ + æ‰‹æ©Ÿç°¡è¨Šé©—è­‰ç¢¼', explanation: 'çµåˆã€Œä½ çŸ¥é“çš„(å¯†ç¢¼)ã€å’Œã€Œä½ æ“æœ‰çš„(æ‰‹æ©Ÿ)ã€å…©ç¨®å› å­ã€‚' },
    
    // --- æ›´å¤šé¡Œç›®è£œå……ä»¥é”æ¨™ ---
    { id: 'q46', type: 'boolean', tags: ['3A4D'], text: 'HTTPS ç¶²é å‚³è¼¸å…§å®¹æœ‰ç¶“éåŠ å¯†ï¼Œæ¯” HTTP å®‰å…¨ã€‚', answer: true, explanation: 'S ä»£è¡¨ Secureï¼Œä½¿ç”¨ TLS/SSL å”å®šã€‚' },
    { id: 'q47', type: 'fill', tags: ['3A4D'], text: 'é›»è…¦ç—…æ¯’ç‚ºäº†é¿å…è¢«ç™¼ç¾ï¼Œé€šå¸¸æœƒé€²è¡Œä»€éº¼å½è£ï¼Ÿ(å¦‚æ›´æ”¹æª”åã€åœ–ç¤º)', answer: ['å½è£', 'éš±è—'], explanation: 'éš±åŒ¿è¹¤è·¡æ˜¯æƒ¡æ„ç¨‹å¼çš„ç‰¹æ€§ã€‚' },
    { id: 'q48', type: 'choice', tags: ['CIA'], text: 'å‹’ç´¢è»Ÿé«”(Ransomware)æŠŠæª”æ¡ˆé–èµ·ä¾†å‹’ç´¢è´–é‡‘ï¼Œä¸»è¦ç ´å£ CIA çš„å“ªä¸€é»ï¼Ÿ', options: ['å¯ç”¨æ€§', 'å®Œæ•´æ€§', 'æ©Ÿå¯†æ€§', 'ä»¥ä¸Šçš†æ˜¯'], answer: 'å¯ç”¨æ€§', explanation: 'ä½¿ç”¨è€…ç„¡æ³•ä½¿ç”¨è‡ªå·±çš„æª”æ¡ˆ(å¯ç”¨æ€§å–ªå¤±)ã€‚' },
    { id: 'q49', type: 'choice', tags: ['3A4D'], text: 'ã€Œç´€éŒ„ (Accounting)ã€åœ¨è³‡å®‰ç®¡ç†ä¸­çš„ä½œç”¨ç‚ºä½•ï¼Ÿ', options: ['è­‰æ˜èº«åˆ†', 'é™åˆ¶æ¬Šé™', 'è¿½è¹¤èˆ‡ç¨½æ ¸ä½¿ç”¨è€…çš„è¡Œç‚º', 'é˜»æ“‹æ”»æ“Š'], answer: 'è¿½è¹¤èˆ‡ç¨½æ ¸ä½¿ç”¨è€…çš„è¡Œç‚º', explanation: 'å‡¡èµ°éå¿…ç•™ä¸‹ç—•è·¡ï¼Œç”¨æ–¼äº‹å¾Œè¿½æŸ¥ã€‚' },
    { id: 'q50', type: 'choice', tags: ['å€‹è³‡'], text: 'åœ¨ä½¿ç”¨ App æ™‚ï¼Œè‹¥ App è¦æ±‚å­˜å–é€šè¨ŠéŒ„ï¼Œä½†è©²åŠŸèƒ½èˆ‡é€šè¨ŠéŒ„ç„¡é—œï¼Œæ‡‰å¦‚ä½•è™•ç†ï¼Ÿ', options: ['å…¨éƒ¨å…è¨±', 'æ‹’çµ•è©²æ¬Šé™', 'åˆªé™¤æ‰‹æ©Ÿ', 'çµ¦äºˆå‡è³‡æ–™'], answer: 'æ‹’çµ•è©²æ¬Šé™', explanation: 'ç¬¦åˆå€‹è³‡æ³•çš„ã€Œæœ€å°è’é›†åŸå‰‡ã€èˆ‡ã€Œèª å¯¦ä¿¡ç”¨åŸå‰‡ã€ã€‚' }
];

/**
 * éŠæˆ²åŠ‡æƒ…æ–‡æœ¬ (10 é—œçµæ§‹)
 * å¢åŠ  quiz ç‰©ä»¶ï¼Œç”¨æ–¼ NPC äº’å‹•å°æ¸¬é©—
 */
const GAME_SCENARIOS = [
    { 
        text: 'ä½ å‰›é€²å…¥æ ¡åœ’ï¼Œç™¼ç¾å­¸æ ¡é–€å£çš„é›»å­ä½ˆå‘Šæ¬„é–ƒçˆç•°å¸¸ï¼Œä¼¼ä¹æœ‰äººè©¦åœ–ç™»å…¥ç®¡ç†ç³»çµ±ã€‚', 
        npc: 'æ ¡é–€è­¦è¡›', 
        msg: 'åŒå­¸ï¼ç³»çµ±æ€ªæ€ªçš„ï¼Œä½ çŸ¥é“æ€éº¼åˆ†è¾¨é€™äº›ç™»å…¥ç•«é¢æ˜¯ä¸æ˜¯å‡çš„å—ï¼Ÿ', 
        quiz: { options: ['æª¢æŸ¥ç¶²å€(URL)æ­£ç¢ºæ€§', 'çœ‹åœ–ç‰‡æ¼‚ä¸æ¼‚äº®'], answer: 'æª¢æŸ¥ç¶²å€(URL)æ­£ç¢ºæ€§' }
    },
    { 
        text: 'ä¾†åˆ°é›»è…¦æ•™å®¤ï¼ŒåŒå­¸å°ç¾æ­£æº–å‚™ç™»å…¥å…¬ç”¨é›»è…¦ï¼Œä½†å¥¹ä¼¼ä¹ä¸å¤ªåœ¨æ„å‘¨åœçš„äººã€‚', 
        npc: 'è³‡å®‰ç²¾éˆ', 
        msg: 'é€™ç¨®å…¬ç”¨ç’°å¢ƒæœ€å±éšªäº†ï¼Œæé†’å¥¹ä¸€ä¸‹ä½¿ç”¨å®Œè©²åšä»€éº¼ï¼Ÿ', 
        quiz: { options: ['ç›´æ¥é—œæ©Ÿé›¢é–‹', 'ç™»å‡ºä¸¦æ¸…é™¤ç€è¦½ç´€éŒ„'], answer: 'ç™»å‡ºä¸¦æ¸…é™¤ç€è¦½ç´€éŒ„' }
    },
    { 
        text: 'æ•™å‹™è™•çš„å°è¡¨æ©Ÿçªç„¶åå‡ºä¸€å †å«æœ‰å­¸ç”Ÿæˆç¸¾çš„å»¢ç´™ï¼Œæ•£è½åœ¨åœ°ä¸Šã€‚', 
        npc: 'æ•™å‹™ä¸»ä»»', 
        msg: 'å“å‘€ï¼é€™äº›éƒ½æ˜¯å€‹è³‡å•Šï¼ä¸èƒ½é€™æ¨£äº‚ä¸Ÿï¼Œè©²æ€éº¼è™•ç†ï¼Ÿ', 
        quiz: { options: ['ä¸Ÿè³‡æºå›æ”¶æ¡¶', 'ä½¿ç”¨ç¢ç´™æ©ŸéŠ·æ¯€'], answer: 'ä½¿ç”¨ç¢ç´™æ©ŸéŠ·æ¯€' }
    },
    { 
        text: 'ä½ çš„ä¿¡ç®±æ”¶åˆ°ä¸€å°ä¸»æ—¨ç‚ºã€Œæ­å–œä¸­ç iPhone 15ã€çš„ä¿¡ä»¶ï¼Œé‚„é™„å¸¶ä¸€å€‹é€£çµã€‚', 
        npc: 'é‡£é­šå‡å†’è€…', 
        msg: 'å˜¿å˜¿ï¼Œåªè¦é»ä¸‹å»å¡«å¯«è³‡æ–™ï¼Œæ‰‹æ©Ÿå°±æ˜¯ä½ çš„å›‰...å¿«é»å§ï¼', 
        quiz: { options: ['é€™æ˜¯é‡£é­šï¼Œæˆ‘ä¸é»', 'é¦¬ä¸Šé»æ“Šé ˜ç'], answer: 'é€™æ˜¯é‡£é­šï¼Œæˆ‘ä¸é»' }
    },
    { 
        text: 'åœ–æ›¸é¤¨çš„æŸ¥è©¢ç³»çµ±çªç„¶è®Šå¾—å¾ˆæ…¢ï¼Œä¼¼ä¹é­å—äº†å¤§é‡çš„ç„¡æ•ˆé€£ç·šæ”»æ“Šã€‚', 
        npc: 'è³‡å®‰ç²¾éˆ', 
        msg: 'é€™çœ‹èµ·ä¾†åƒæ˜¯ DDoS æ”»æ“Šï¼Œé€™ç¨®è®“ç³»çµ±ç„¡æ³•ä½¿ç”¨çš„æ”»æ“Šæ˜¯ç ´å£äº†ä»€éº¼ï¼Ÿ', 
        quiz: { options: ['å¯ç”¨æ€§(Availability)', 'æ©Ÿå¯†æ€§(Confidentiality)'], answer: 'å¯ç”¨æ€§(Availability)' }
    },
    { 
        text: 'åœ¨èµ°å»Šä¸Šæ’¿åˆ°ä¸€å€‹æ¨™ç¤ºã€Œæ©Ÿå¯†ã€çš„éš¨èº«ç¢Ÿï¼Œå¥½å¥‡å¿ƒé©…ä½¿ä½ æƒ³æŠŠå®ƒæ’ä¸Šé›»è…¦ã€‚', 
        npc: 'è³‡å®‰ç²¾éˆ', 
        msg: 'ç­‰ç­‰ï¼ä¾†è·¯ä¸æ˜çš„ USB å¯æ˜¯è¶…ç´šæ¯’è—¥ï¼ä½ è©²æ€éº¼åšï¼Ÿ', 
        quiz: { options: ['å…ˆæ’çœ‹çœ‹æœ‰ä»€éº¼', 'äº¤çµ¦è³‡è¨Šçµ„/ä¸äº‚æ’'], answer: 'äº¤çµ¦è³‡è¨Šçµ„/ä¸äº‚æ’' }
    },
    { 
        text: 'æœ‰åŒå­¸æ­£åœ¨ç¤¾ç¾¤ç¶²ç«™ä¸Šå¤§è‚†è¨è«–éš”å£ç­åŒå­¸çš„å…«å¦ï¼Œç”šè‡³è²¼å‡ºäº†å°æ–¹çš„è¨ºæ–·è­‰æ˜æ›¸ã€‚', 
        npc: 'æ•™å‹™ä¸»ä»»', 
        msg: 'é€™å·²ç¶“è§¸çŠ¯æ³•å¾‹äº†ï¼é‚£æ˜¯æ•æ„Ÿæ€§å€‹è³‡å•Šï¼ä½ è©²æ€éº¼åšï¼Ÿ', 
        quiz: { options: ['åŠ å…¥è¨è«–æŒ‰è®š', 'å‹¸é˜»ä¸¦æª¢èˆ‰'], answer: 'å‹¸é˜»ä¸¦æª¢èˆ‰' }
    },
    { 
        text: 'å­¸æ ¡ç¶²ç«™ç®¡ç†è€…å¸³è™Ÿè¢«ç›œç”¨äº†ï¼ŒåŸä¾†æ˜¯å› ç‚ºå¯†ç¢¼è¨­æˆäº†ã€Œ123456ã€ã€‚', 
        npc: 'è³‡å®‰ç²¾éˆ', 
        msg: 'å¼±å¯†ç¢¼æ˜¯è³‡å®‰å¤§å¿Œï¼Œå¿«å¹«å¿™æƒ³å€‹å¼·å¯†ç¢¼åŸå‰‡ã€‚', 
        quiz: { options: ['ä½¿ç”¨è‹±æ•¸ç¬¦è™Ÿæ··åˆ', 'ä½¿ç”¨ç”Ÿæ—¥+é›»è©±'], answer: 'ä½¿ç”¨è‹±æ•¸ç¬¦è™Ÿæ··åˆ' }
    },
    { 
        text: 'é§­å®¢è©¦åœ–ç«„æ”¹å­¸æ ¡åˆé¤èœå–®ï¼ŒæŠŠé’èœå…¨éƒ¨æ”¹æˆç‚¸é›ã€‚', 
        npc: 'å»šæˆ¿é˜¿å§¨', 
        msg: 'é›–ç„¶æˆ‘å¾ˆæƒ³ç…®ç‚¸é›ï¼Œä½†é€™èœå–®è¢«æ”¹éäº†å§ï¼Ÿæˆ‘å€‘éœ€è¦ç¢ºèªè³‡æ–™çš„ä»€éº¼ç‰¹æ€§ï¼Ÿ', 
        quiz: { options: ['å®Œæ•´æ€§(Integrity)', 'æ©Ÿå¯†æ€§(Confidentiality)'], answer: 'å®Œæ•´æ€§(Integrity)' }
    },
    { 
        text: 'æœ€çµ‚æ±ºæˆ°ï¼é§­å®¢ç™¼å‹•ç¸½æ”»æ“Šï¼Œè©¦åœ–ç«Šå–å…¨æ ¡å¸«ç”Ÿè³‡æ–™åº«ã€‚', 
        npc: 'è³‡å®‰ç²¾éˆ', 
        msg: 'å®ˆè­·è€…ï¼Œé€™æ˜¯æœ€å¾Œä¸€é—œï¼Œä½ æº–å‚™å¥½é¢å°æŒ‘æˆ°äº†å—ï¼Ÿ', 
        quiz: { options: ['æˆ‘æº–å‚™å¥½äº†ï¼', 'å†ç­‰ä¸€ä¸‹'], answer: 'æˆ‘æº–å‚™å¥½äº†ï¼' }
    }
];

const App = {
    // ç‹€æ…‹
    state: {
        user: null, // {class, seat, name}
        level: 0,
        score: 0,
        startTime: 0,
        timerInterval: null,
        timeSpent: 0,
        currentRunId: null,
        inventory: { firewall: 2, scroll: 2, lens: 2, log: 2 },
        currentQuestions: [], // æœ¬è¼ªé¡Œç›®
        history: [], // æœ¬è¼ªä½œç­”è©³ç´°
        currentQ: null, // ç•¶å‰é¡Œç›®ç‰©ä»¶
        usedItem: null, // ç•¶å‰é¡Œç›®ä½¿ç”¨çš„é“å…·
        config: {
            tags: ['å€‹è³‡', 'CIA', 'é‡£é­š', '3A4D'] // é è¨­å…¨é¸
        }
    },

    // åˆå§‹åŒ–
    init() {
        this.loadTeacherConfig();
        // ç¢ºä¿æŒ‰éˆ•äº‹ä»¶ç¶å®š
        const loginInput = document.getElementById('login-class');
        if(loginInput) loginInput.focus();
    },

    loadTeacherConfig() {
        const cfg = localStorage.getItem('edu_security_game_config');
        if (cfg) {
            this.state.config = JSON.parse(cfg);
            // Update UI checkboxes
            document.querySelectorAll('#chapter-checks input').forEach(cb => {
                cb.checked = this.state.config.tags.includes(cb.value);
            });
        }
    },

    saveConfig() {
        const checked = Array.from(document.querySelectorAll('#chapter-checks input:checked')).map(cb => cb.value);
        if (checked.length === 0) {
            alert("è«‹è‡³å°‘é¸æ“‡ä¸€å€‹ç« ç¯€ï¼");
            return;
        }
        this.state.config.tags = checked;
        localStorage.setItem('edu_security_game_config', JSON.stringify(this.state.config));
        
        const status = document.getElementById('config-status');
        status.style.display = 'inline';
        setTimeout(() => status.style.display = 'none', 2000);
    },

    // ç•«é¢åˆ‡æ›
    switchScreen(id) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
    },

    // ç™»å…¥è™•ç†
    handleLogin() {
        const cls = document.getElementById('login-class').value.trim();
        const seat = document.getElementById('login-seat').value.trim();
        const name = document.getElementById('login-name').value.trim();

        if (!cls || !seat || !name) {
            alert("è«‹å®Œæ•´å¡«å¯«ç­ç´šã€åº§è™Ÿã€å§“åï¼");
            return;
        }

        this.state.user = { class: cls, seat, name };
        this.startGame();
    },

    // éŠæˆ²é–‹å§‹
    startGame() {
        this.state.level = 0;
        this.state.score = 0;
        this.state.inventory = { firewall: 2, scroll: 2, lens: 2, log: 2 };
        this.state.history = [];
        this.state.currentRunId = Date.now().toString(36);
        this.updateInventoryUI();

        // é¡Œç›®ç¯©é¸èˆ‡æŠ½å–
        let pool = QUESTION_POOL.filter(q => {
            // åªè¦é¡Œç›® tag æœ‰åŒ…å«ä»»ä½•ä¸€å€‹é¸ä¸­çš„ tag å³å¯
            return q.tags.some(t => this.state.config.tags.includes(t));
        });

        // è£œé¡Œæ©Ÿåˆ¶ (å¦‚æœç¯©é¸å¾Œå°‘æ–¼10é¡Œï¼Œå°±å¾å…¨é¡Œåº«è£œ)
        if (pool.length < 10) {
            console.warn("é¡Œåº«ç¯©é¸å¾Œä¸è¶³ 10 é¡Œï¼Œå·²è‡ªå‹•è£œé¡Œ");
            const usedIds = pool.map(q => q.id);
            const others = QUESTION_POOL.filter(q => !usedIds.includes(q.id));
            // æ´—ç‰Œè£œå……
            others.sort(() => Math.random() - 0.5);
            pool = pool.concat(others.slice(0, 10 - pool.length));
        }

        // æ´—ç‰Œä¸¦å–å‰ 10 é¡Œ
        pool.sort(() => Math.random() - 0.5);
        this.state.currentQuestions = pool.slice(0, 10);

        this.switchScreen('screen-game');
        this.loadLevel();
    },

    // è¼‰å…¥é—œå¡
    loadLevel() {
        if (this.state.level >= 10) {
            this.endGame();
            return;
        }

        const levelIdx = this.state.level;
        const q = this.state.currentQuestions[levelIdx];
        this.state.currentQ = q;
        this.state.usedItem = null; // é‡ç½®æœ¬é¡Œé“å…·ä½¿ç”¨

        // UI æ›´æ–°
        document.getElementById('game-level').textContent = `é—œå¡ ${levelIdx + 1}/10`;
        document.getElementById('game-score').textContent = `ğŸ† ${this.state.score}`;
        document.getElementById('progress-fill').style.width = `${(levelIdx / 10) * 100}%`;

        // è¼‰å…¥åŠ‡æƒ…
        const scenario = GAME_SCENARIOS[levelIdx] || GAME_SCENARIOS[0];
        document.getElementById('story-text').textContent = scenario.text;
        document.getElementById('npc-name').textContent = scenario.npc;
        document.getElementById('npc-msg').textContent = scenario.msg;
        document.getElementById('npc-avatar').textContent = ['ğŸ‘¨â€ğŸ«','ğŸ§šâ€â™€ï¸','ğŸ¦¹','ğŸ¤–'][levelIdx % 4]; // éš¨æ©Ÿé ­åƒ

        // NPC é¸é … / äº’å‹•å°æ¸¬é©—
        const choicesDiv = document.getElementById('npc-choices');
        choicesDiv.innerHTML = '';
        
        // æ¸²æŸ“äº’å‹•æ¸¬é©—æŒ‰éˆ•
        if (scenario.quiz && scenario.quiz.options) {
            // éš¨æ©Ÿæ’åˆ—é¸é …æŒ‰éˆ•
            let opts = [...scenario.quiz.options];
            opts.sort(() => Math.random() - 0.5);
            
            opts.forEach(opt => {
                const btn = document.createElement('button');
                btn.className = 'btn btn-small btn-secondary';
                btn.textContent = opt;
                btn.onclick = () => {
                    // æª¢æŸ¥ç­”æ¡ˆ
                    if (opt === scenario.quiz.answer) {
                        // ç­”å°ï¼Œé€²å…¥é¡Œç›®
                        document.getElementById('scene-area').style.display = 'none';
                        this.showQuestion();
                    } else {
                        // ç­”éŒ¯ï¼Œæç¤º
                        alert('âŒ è§€å¿µæœ‰é»å°èª¤å·®å–”ï¼\n\n' + scenario.npc + ' è¡¨ç¤ºï¼šã€Œå†æƒ³ä¸€æƒ³ï¼Œé€™æ¨£åšçœŸçš„å®‰å…¨å—ï¼Ÿã€');
                    }
                };
                choicesDiv.appendChild(btn);
            });
        } else {
            // èˆŠç‰ˆå…¼å®¹ (è‹¥ç„¡ quiz è¨­å®š)
            const btn = document.createElement('button');
            btn.className = 'btn btn-small btn-secondary';
            btn.textContent = 'æˆ‘çŸ¥é“äº†ï¼Œé€²å…¥æŒ‘æˆ°';
            btn.onclick = () => {
                document.getElementById('scene-area').style.display = 'none';
                this.showQuestion();
            };
            choicesDiv.appendChild(btn);
        }

        document.getElementById('scene-area').style.display = 'block';
        document.getElementById('quiz-area').style.display = 'none';
        
        // é‡ç½®é“å…·æŒ‰éˆ•ç‹€æ…‹ (å¦‚æœæ˜¯é¸æ“‡é¡Œæ‰å¯ç”¨é˜²ç«ç‰†)
        this.updateInventoryUI();
    },

    showQuestion() {
        const q = this.state.currentQ;
        const qArea = document.getElementById('quiz-area');
        qArea.style.display = 'block';
        document.getElementById('q-text').textContent = `[${q.type === 'choice'?'é¸æ“‡':q.type==='boolean'?'æ˜¯é':'å¡«å……'}] ${q.text}`;

        const optsDiv = document.getElementById('q-options');
        const inputDiv = document.getElementById('q-input-area');
        optsDiv.innerHTML = '';
        inputDiv.style.display = 'none';
        document.getElementById('q-input').value = '';

        this.startTimer();

        if (q.type === 'choice' || q.type === 'boolean') {
            let options = q.type === 'choice' ? [...q.options] : ['O (True)', 'X (False)'];
            // å¦‚æœæ˜¯é¸æ“‡é¡Œï¼Œéš¨æ©Ÿæ’åˆ—é¸é … (æ˜¯éé¡Œä¸æ’)
            if (q.type === 'choice') options.sort(() => Math.random() - 0.5);

            options.forEach(opt => {
                const btn = document.createElement('button');
                btn.className = 'option-btn';
                btn.textContent = opt;
                btn.onclick = () => this.submitAnswer(opt);
                optsDiv.appendChild(btn);
            });
        } else {
            inputDiv.style.display = 'block';
        }
    },

    startTimer() {
        clearInterval(this.state.timerInterval);
        this.state.startTime = Date.now();
        const timerEl = document.getElementById('game-timer');
        this.state.timerInterval = setInterval(() => {
            const sec = Math.floor((Date.now() - this.state.startTime) / 1000);
            timerEl.textContent = `â³ ${sec < 10 ? '0'+sec : sec}s`;
        }, 1000);
    },

    // é“å…·ç³»çµ±
    useItem(type) {
        if (this.state.inventory[type] <= 0) return;
        const q = this.state.currentQ;
        const btns = document.querySelectorAll('.option-btn');

        if (type === 'firewall') {
            if (q.type !== 'choice') { alert('é˜²ç«ç‰†åªèƒ½ç”¨æ–¼é¸æ“‡é¡Œï¼'); return; }
            // åˆªé™¤ä¸€å€‹éŒ¯èª¤é¸é …
            let wrongBtns = Array.from(btns).filter(b => b.textContent !== q.answer && !b.classList.contains('hidden-opt'));
            if (wrongBtns.length > 0) {
                wrongBtns[0].classList.add('hidden-opt');
                this.consumeItem(type);
            }
        } else if (type === 'scroll') {
            // æç¤º
            let hint = '';
            if (q.type === 'fill') hint = `æç¤ºï¼šç­”æ¡ˆåŒ…å«ã€Œ${Array.isArray(q.answer)?q.answer[0][0]:q.answer[0]}...ã€`;
            else hint = `æç¤ºï¼šèˆ‡ã€Œ${q.tags.join(',')}ã€ç›¸é—œæ¦‚å¿µã€‚`;
            alert(`ğŸ“œ åŠ å¯†å·è»¸è§£å¯†ï¼š\n${hint}\n\n(ä»”ç´°çœ‹é¡Œç›®çš„é—œéµå­—ï¼)`);
            this.consumeItem(type);
        } else if (type === 'lens') {
            // æª¢æŸ¥æ¸…å–®
            alert(`ğŸ” é‡£é­šåµæ¸¬é¡æƒæä¸­...\n\næª¢æŸ¥æ¸…å–®ï¼š\n1. ä¾†æºæ˜¯å¦å¯ä¿¡ï¼Ÿ\n2. ç¶²å€æ˜¯å¦æ­£ç¢ºï¼Ÿ\n3. æ˜¯å¦è£½é€ ç·Šæ€¥æ„Ÿï¼Ÿ\n\n(æœ¬é¡Œè€ƒé»ï¼š${q.tags.join('/')})`);
            this.consumeItem(type);
        } else if (type === 'log') {
            // æ¨™è¨˜æœ¬é¡ŒçµæŸå¾Œé¡¯ç¤ºè©³ç´°
            alert('ğŸ§¾ å·²å•Ÿç”¨ç¨½æ ¸ç´€éŒ„ã€‚\næœ¬é¡Œä½œç­”å¾Œå°‡é¡¯ç¤ºè©³ç´°è§£æï¼');
            this.state.inventory[type]--; // é€™è£¡å…ˆæ‰£ï¼Œå› ç‚ºæ˜¯ç‹€æ…‹æ¨™è¨˜
            this.state.usedItem = 'log'; // è¦†è“‹ä¹‹å‰çš„é“å…·ç´€éŒ„ (ç°¡åŒ–é‚è¼¯)
            this.updateInventoryUI();
        }
    },

    consumeItem(type) {
        this.state.inventory[type]--;
        this.state.usedItem = type;
        this.updateInventoryUI();
    },

    updateInventoryUI() {
        for (let k in this.state.inventory) {
            const el = document.getElementById(`count-${k}`);
            const btn = document.getElementById(`item-${k}`);
            el.textContent = `x${this.state.inventory[k]}`;
            if (this.state.inventory[k] <= 0) {
                btn.classList.remove('available');
                btn.disabled = true;
            } else {
                btn.classList.add('available');
                btn.disabled = false;
            }
        }
        // ç‰¹æ®Šè™•ç†ï¼šé˜²ç«ç‰†åªèƒ½åœ¨é¸æ“‡é¡Œ
        if (this.state.currentQ && this.state.currentQ.type !== 'choice') {
             document.getElementById('item-firewall').disabled = true;
             document.getElementById('item-firewall').classList.remove('available');
        }
    },

    // æäº¤ç­”æ¡ˆ
    submitAnswer(inputAnswer = null) {
        clearInterval(this.state.timerInterval);
        const q = this.state.currentQ;
        const timeSpent = Math.floor((Date.now() - this.state.startTime) / 1000);
        
        if (!inputAnswer) {
            inputAnswer = document.getElementById('q-input').value.trim();
        }

        // åˆ¤æ–·å°éŒ¯
        let isCorrect = false;
        if (q.type === 'choice') {
            isCorrect = (inputAnswer === q.answer);
        } else if (q.type === 'boolean') {
            const boolAns = q.answer ? 'O (True)' : 'X (False)';
            isCorrect = (inputAnswer === boolAns);
        } else if (q.type === 'fill') {
            // å¡«å……é¡Œæ”¯æ´å¤šå€‹æ­£ç¢ºç­”æ¡ˆ (é™£åˆ—)
            const userText = inputAnswer.toLowerCase();
            isCorrect = q.answer.some(ans => userText.includes(ans.toLowerCase()));
        }

        if (isCorrect) this.state.score += 10;

        // ç´€éŒ„
        this.state.history.push({
            qId: q.id,
            qText: q.text,
            type: q.type,
            studentAnswer: inputAnswer,
            correctAnswer: Array.isArray(q.answer) ? q.answer[0] : (typeof q.answer === 'boolean' ? (q.answer?'O':'X') : q.answer),
            isCorrect: isCorrect,
            timeSpent: timeSpent,
            itemUsed: this.state.usedItem || '',
            scoreAfter: this.state.score,
            explanation: q.explanation
        });

        // é¡¯ç¤ºå›é¥‹
        const modal = document.getElementById('feedback-modal');
        const icon = document.getElementById('fb-icon');
        const title = document.getElementById('fb-title');
        const msg = document.getElementById('fb-msg');
        const auditArea = document.getElementById('audit-log-extra');

        modal.style.display = 'flex';
        icon.textContent = isCorrect ? 'âœ…' : 'âŒ';
        title.textContent = isCorrect ? 'ç­”å°äº†ï¼' : 'ç­”éŒ¯äº†...';
        title.className = isCorrect ? 'correct' : 'wrong';
        msg.textContent = q.explanation;

        // ç¨½æ ¸ç´€éŒ„é“å…·æ•ˆæœ
        if (this.state.usedItem === 'log') {
            auditArea.style.display = 'block';
            document.getElementById('audit-text').textContent = `
                çŸ¥è­˜é»: ${q.tags.join(', ')}
                æ­£ç¢ºç­”æ¡ˆ: ${Array.isArray(q.answer) ? q.answer.join(' æˆ– ') : (typeof q.answer === 'boolean' ? (q.answer?'O':'X') : q.answer)}
                è§£æè©³æ–‡: ${q.explanation} (è«‹ç‰¢è¨˜æ­¤æ¦‚å¿µä»¥é˜²ç¯„é¢¨éšªï¼)
            `;
        } else {
            auditArea.style.display = 'none';
        }
    },

    closeFeedback() {
        document.getElementById('feedback-modal').style.display = 'none';
        this.state.level++;
        this.loadLevel();
    },

    // éŠæˆ²çµæŸ
    endGame() {
        this.switchScreen('screen-result');
        const correctCount = this.state.history.filter(h => h.isCorrect).length;
        const totalTime = this.state.history.reduce((a, b) => a + b.timeSpent, 0);

        document.getElementById('final-score').textContent = this.state.score;
        document.getElementById('final-accuracy').textContent = `${correctCount * 10}%`;
        document.getElementById('final-time').textContent = `${totalTime}s`;

        // éŒ¯é¡Œåˆ—è¡¨
        const reviewDiv = document.getElementById('review-list');
        reviewDiv.innerHTML = '';
        const wrongs = this.state.history.filter(h => !h.isCorrect);
        
        if (wrongs.length === 0) {
            reviewDiv.innerHTML = '<p style="color:var(--success)">å¤ªå¼·äº†ï¼å…¨å°ï¼è³‡å®‰å¤§å¸«ï¼ğŸ›¡ï¸</p>';
        } else {
            wrongs.forEach(w => {
                const div = document.createElement('div');
                div.style.marginBottom = '10px';
                div.style.padding = '10px';
                div.style.background = '#fee2e2';
                div.style.borderRadius = '8px';
                div.innerHTML = `
                    <strong>${w.qText}</strong><br>
                    <span style="color:red">ä½ çš„ç­”æ¡ˆ: ${w.studentAnswer}</span> | 
                    <span style="color:green">æ­£è§£: ${w.correctAnswer}</span><br>
                    <small>${w.explanation}</small>
                `;
                reviewDiv.appendChild(div);
            });
        }

        this.saveRecordToStorage(totalTime);
    },

    saveRecordToStorage(totalTime) {
        const record = {
            timestamp: new Date().toISOString(),
            runId: this.state.currentRunId,
            class: this.state.user.class,
            seat: this.state.user.seat,
            name: this.state.user.name,
            score: this.state.score,
            totalTime: totalTime,
            itemCount: Object.values(this.state.inventory).reduce((a, b) => 2 - b + a, 0), // ç²—ç•¥è¨ˆç®—ç”¨äº†å¹¾å€‹
            details: this.state.history
        };

        let allData = JSON.parse(localStorage.getItem('edu_security_game_history') || '[]');
        allData.push(record);
        localStorage.setItem('edu_security_game_history', JSON.stringify(allData));
    },

    // --- è€å¸«å¾Œå°åŠŸèƒ½ ---

    toggleTeacherPanel() {
        const modal = document.getElementById('password-modal');
        const input = document.getElementById('teacher-pwd-input');
        if(modal && input) {
            input.value = ''; // clear previous input
            modal.style.display = 'flex';
            input.focus();
        }
    },

    closePasswordModal() {
        document.getElementById('password-modal').style.display = 'none';
    },

    checkTeacherPassword() {
        const input = document.getElementById('teacher-pwd-input');
        const pwd = input.value;

        // ç°¡å–®çš„é›œæ¹Šå‡½æ•¸ï¼Œé¿å…å¯†ç¢¼æ˜æ–‡ç›´æ¥æš´éœ²åœ¨åŸå§‹ç¢¼ä¸­
        // ç›®æ¨™å¯†ç¢¼: 0426 -> hash: 1481544
        const checkHash = (s) => {
            let h = 0;
            for(let i=0; i<s.length; i++) {
                // (h << 5) - h ç­‰åŒæ–¼ h * 31
                h = ((h << 5) - h) + s.charCodeAt(i);
                h |= 0; // è½‰ç‚º 32bit æ•´æ•¸
            }
            return h;
        };
        
        if (checkHash(pwd) === 1481544) {
            this.closePasswordModal();
            this.renderDashboard();
            this.switchScreen('screen-dashboard');
        } else {
            alert("å¯†ç¢¼éŒ¯èª¤");
            input.value = '';
            input.focus();
        }
    },

    renderDashboard() {
        const data = JSON.parse(localStorage.getItem('edu_security_game_history') || '[]');
        const tbody = document.querySelector('#dash-table tbody');
        const filter = document.getElementById('dash-search').value.toLowerCase();
        
        tbody.innerHTML = '';
        
        // æ’åºï¼šæœ€æ–°çš„åœ¨æœ€ä¸Šé¢
        const sorted = data.sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp));

        sorted.forEach((r, idx) => {
            if (filter && !r.name.includes(filter) && !r.class.includes(filter)) return;

            const tr = document.createElement('tr');
            const dateStr = new Date(r.timestamp).toLocaleString();
            tr.innerHTML = `
                <td>${dateStr}</td>
                <td>${r.class}</td>
                <td>${r.name}</td>
                <td>${r.details.length}</td>
                <td>${r.score}</td>
                <td><button class="btn btn-small" onclick="app.showDetail(${idx})">æŸ¥çœ‹</button></td>
            `;
            tbody.appendChild(tr);
        });
    },

    showDetail(idx) {
        const data = JSON.parse(localStorage.getItem('edu_security_game_history') || '[]');
        // å› ç‚º render æ™‚æœ‰ sortï¼Œé€™è£¡è¦é‡æ–°æ‰¾æˆ–è€…ç°¡å–®é»ï¼šrenderæ™‚æŠŠåŸå§‹indexå­˜é€²å»ã€‚
        // ç‚ºç°¡åŒ–ï¼Œé€™è£¡é‡æ–° sort ä¸€æ¬¡ä»¥åŒ¹é… index (åœ¨çœŸå¯¦å°ˆæ¡ˆä¸­æ‡‰è©²ç”¨ ID)
        const sorted = data.sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp));
        const record = sorted[idx];
        
        const detailDiv = document.getElementById('dash-detail');
        const contentDiv = document.getElementById('dash-detail-content');
        detailDiv.style.display = 'block';
        
        let html = `<p><strong>${record.class} ${record.name}</strong> (ç¸½åˆ†: ${record.score})</p>`;
        html += `<table style="font-size:0.8rem"><tr><th>é¡Œç›®</th><th>ä½œç­”</th><th>æ­£èª¤</th><th>é“å…·</th></tr>`;
        
        record.details.forEach(d => {
            html += `
                <tr>
                    <td>${d.qText.substring(0, 20)}...</td>
                    <td>${d.studentAnswer}</td>
                    <td style="color:${d.isCorrect?'green':'red'}">${d.isCorrect?'O':'X'}</td>
                    <td>${d.itemUsed || '-'}</td>
                </tr>
            `;
        });
        html += `</table>`;
        contentDiv.innerHTML = html;
        // æ»¾å‹•åˆ°åº•éƒ¨
        detailDiv.scrollIntoView({behavior: 'smooth'});
    },

    exportCSV() {
        const data = JSON.parse(localStorage.getItem('edu_security_game_history') || '[]');
        if (data.length === 0) { alert('ç„¡è³‡æ–™å¯åŒ¯å‡º'); return; }

        // CSV Header
        let csvContent = '\uFEFF'; // BOM for Excel
        csvContent += "Timestamp,Class,Seat,Name,RunID,Level,Q_ID,Type,Question,StudentAnswer,CorrectAnswer,IsCorrect,TimeSpent,ItemUsed,ScoreAfter\n";

        data.forEach(run => {
            run.details.forEach((d, i) => {
                // è™•ç†é€—è™Ÿé¿å… CSV æ ¼å¼è·‘æ‰
                const safeQ = `"${d.qText.replace(/"/g, '""')}"`;
                const safeAns = `"${d.studentAnswer.replace(/"/g, '""')}"`;
                
                const row = [
                    run.timestamp,
                    run.class,
                    run.seat,
                    run.name,
                    run.runId,
                    i + 1,
                    d.qId,
                    d.type,
                    safeQ,
                    safeAns,
                    d.correctAnswer,
                    d.isCorrect ? 'TRUE' : 'FALSE',
                    d.timeSpent,
                    d.itemUsed,
                    d.scoreAfter
                ].join(",");
                csvContent += row + "\n";
            });
        });

        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement("a");
        link.setAttribute("href", url);
        link.setAttribute("download", `è³‡å®‰å‹‡è€…_ä½œç­”ç´€éŒ„_${new Date().toISOString().slice(0,10)}.csv`);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    },

    clearData() {
        if (confirm("ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰å­¸ç”Ÿä½œç­”ç´€éŒ„å—ï¼Ÿæ­¤å‹•ä½œç„¡æ³•å¾©åŸï¼")) {
            if (confirm("å†æ¬¡ç¢ºèªï¼šçœŸçš„è¦åˆªé™¤å—ï¼Ÿ")) {
                localStorage.removeItem('edu_security_game_history');
                this.renderDashboard();
                alert("è³‡æ–™å·²æ¸…é™¤");
                document.getElementById('dash-detail').style.display = 'none';
            }
        }
    }
};

const app = App;
window.onload = () => app.init();

</script>
</body>
</html>
